{% load core_filters %}

<div class="table-responsive">
    <table class="table table-bordered table-striped table-hover mb-0 table-job-list">
        <thead class="text-center align-middle">
            <tr>
                <th>No</th>
                <th><a href="?{% if request.GET.month %}month={{ request.GET.month }}&{% endif %}{% if request.GET.year %}year={{ request.GET.year }}&{% endif %}{% if request.GET.pic %}pic={{ request.GET.pic }}&{% endif %}{% if request.GET.line %}line={{ request.GET.line }}&{% endif %}{% if request.GET.mesin %}mesin={{ request.GET.mesin }}&{% endif %}{% if request.GET.sub_mesin %}sub_mesin={{ request.GET.sub_mesin }}&{% endif %}sort=nama_pekerjaan&order={% if sort_by == 'nama_pekerjaan' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">Nama Pekerjaan {% if sort_by == 'nama_pekerjaan' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?{% if request.GET.month %}month={{ request.GET.month }}&{% endif %}{% if request.GET.year %}year={{ request.GET.year }}&{% endif %}{% if request.GET.pic %}pic={{ request.GET.pic }}&{% endif %}{% if request.GET.line %}line={{ request.GET.line }}&{% endif %}{% if request.GET.mesin %}mesin={{ request.GET.mesin }}&{% endif %}{% if request.GET.sub_mesin %}sub_mesin={{ request.GET.sub_mesin }}&{% endif %}sort=pic&order={% if sort_by == 'pic' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">PIC {% if sort_by == 'pic' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th>Personil</th>
                <th><a href="?{% if request.GET.month %}month={{ request.GET.month }}&{% endif %}{% if request.GET.year %}year={{ request.GET.year }}&{% endif %}{% if request.GET.pic %}pic={{ request.GET.pic }}&{% endif %}{% if request.GET.line %}line={{ request.GET.line }}&{% endif %}{% if request.GET.mesin %}mesin={{ request.GET.mesin }}&{% endif %}{% if request.GET.sub_mesin %}sub_mesin={{ request.GET.sub_mesin }}&{% endif %}sort=line&order={% if sort_by == 'line' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">Line {% if sort_by == 'line' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?{% if request.GET.month %}month={{ request.GET.month }}&{% endif %}{% if request.GET.year %}year={{ request.GET.year }}&{% endif %}{% if request.GET.pic %}pic={{ request.GET.pic }}&{% endif %}{% if request.GET.line %}line={{ request.GET.line }}&{% endif %}{% if request.GET.mesin %}mesin={{ request.GET.mesin }}&{% endif %}{% if request.GET.sub_mesin %}sub_mesin={{ request.GET.sub_mesin }}&{% endif %}sort=mesin&order={% if sort_by == 'mesin' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">Mesin {% if sort_by == 'mesin' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?{% if request.GET.month %}month={{ request.GET.month }}&{% endif %}{% if request.GET.year %}year={{ request.GET.year }}&{% endif %}{% if request.GET.pic %}pic={{ request.GET.pic }}&{% endif %}{% if request.GET.line %}line={{ request.GET.line }}&{% endif %}{% if request.GET.mesin %}mesin={{ request.GET.mesin }}&{% endif %}{% if request.GET.sub_mesin %}sub_mesin={{ request.GET.sub_mesin }}&{% endif %}sort=sub_mesin&order={% if sort_by == 'sub_mesin' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">Sub Mesin {% if sort_by == 'sub_mesin' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?{% if request.GET.month %}month={{ request.GET.month }}&{% endif %}{% if request.GET.year %}year={{ request.GET.year }}&{% endif %}{% if request.GET.pic %}pic={{ request.GET.pic }}&{% endif %}{% if request.GET.line %}line={{ request.GET.line }}&{% endif %}{% if request.GET.mesin %}mesin={{ request.GET.mesin }}&{% endif %}{% if request.GET.sub_mesin %}sub_mesin={{ request.GET.sub_mesin }}&{% endif %}sort=fokus&order={% if sort_by == 'fokus' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">Fokus {% if sort_by == 'fokus' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?{% if request.GET.month %}month={{ request.GET.month }}&{% endif %}{% if request.GET.year %}year={{ request.GET.year }}&{% endif %}{% if request.GET.pic %}pic={{ request.GET.pic }}&{% endif %}{% if request.GET.line %}line={{ request.GET.line }}&{% endif %}{% if request.GET.mesin %}mesin={{ request.GET.mesin }}&{% endif %}{% if request.GET.sub_mesin %}sub_mesin={{ request.GET.sub_mesin }}&{% endif %}sort=prioritas&order={% if sort_by == 'prioritas' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">Prioritas {% if sort_by == 'prioritas' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th>Jadwal Rencana</th>
                <th><a href="?{% if request.GET.month %}month={{ request.GET.month }}&{% endif %}{% if request.GET.year %}year={{ request.GET.year }}&{% endif %}{% if request.GET.pic %}pic={{ request.GET.pic }}&{% endif %}{% if request.GET.line %}line={{ request.GET.line }}&{% endif %}{% if request.GET.mesin %}mesin={{ request.GET.mesin }}&{% endif %}{% if request.GET.sub_mesin %}sub_mesin={{ request.GET.sub_mesin }}&{% endif %}sort=progress&order={% if sort_by == 'progress' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">Progres {% if sort_by == 'progress' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th>Lampiran</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
{% for data in job_data %}
<tr>
<td class="text-center">{{ forloop.counter }}</td>
<td>{% if data.tipe_job == 'Project' and data.project %}<a href="{% url 'core:project_detail' data.project.id %}" class="text-decoration-none"><strong>{{ data.nama_pekerjaan }}</strong><br><span class="badge text-bg-info"><i class="bi bi-diagram-3-fill"></i> {{ data.project.nama_project }}</span></a>
{% if data.assigned_to %}{% if data.pic == request.user %}<br><span class="badge text-bg-warning"><i class="bi bi-arrow-right-circle"></i> Assign To: {{ data.assigned_to.username }}</span>{% else %}<br><span class="badge text-bg-secondary"><i class="bi bi-arrow-left-circle"></i> Assign From: {{ data.pic.username }}</span>{% endif %}{% endif %}
{% else %}<strong>{{ data.nama_pekerjaan }}</strong>{% if data.assigned_to %}{% if data.pic == request.user %}<br><span class="badge text-bg-warning"><i class="bi bi-arrow-right-circle"></i> Assign To: {{ data.assigned_to.username }}</span>{% else %}<br><span class="badge text-bg-secondary"><i class="bi bi-arrow-left-circle"></i> Assign From: {{ data.pic.username }}</span>{% endif %}{% endif %}{% endif %}</td>
<td class="text-center">{{ data.pic.username }}</td>
<td class="p-1"><div class="d-flex flex-wrap">{% for personil in data.personil_ditugaskan.all %}<span class="badge badge-personil">{{ personil.nama_lengkap }}</span>{% empty %}<span class="text-muted small"><em>(Belum ada)</em></span>{% endfor %}</div></td>
<td>{{ data.aset.parent.parent.nama|default:'-' }}</td>
<td>{{ data.aset.parent.nama|default:'-' }}</td>
<td>{{ data.aset.nama|default:'-' }}</td>
<td class="text-center">{{ data.get_fokus_display }}</td>
<td class="text-center"><span class="badge {% if data.prioritas == 'P1' %}badge-p1{% elif data.prioritas == 'P2' %}badge-p2{% elif data.prioritas == 'P3' %}badge-p3{% else %}badge-p4{% endif %}">{{ data.get_prioritas_display }}</span></td>
<td class="p-1"><div class="jadwal-btn-list">{% for jd in data.tanggal_pelaksanaan.all|slice:":10" %}<button type="button" class="btn jadwal-btn {% if jd.status == 'Done' %}btn-success{% endif %}{% if jd.status == 'Open' %}btn-outline-danger{% endif %}{% if jd.status == 'Pending' %}btn-warning{% endif %}{% if jd.status == 'N/A' %}btn-secondary{% endif %}" data-bs-toggle="modal" data-bs-target="#jobDateModal" data-jobdate-id="{{ jd.id }}" data-jobdate-status="{{ jd.status }}" data-jobdate-catatan="{{ jd.catatan|default:'' }}" data-jobdate-info="{{ data.nama_pekerjaan }} ({{ jd.tanggal|date:'d M Y' }})">{{ jd.tanggal|date:"d M" }} ({{ jd.status }})</button>{% endfor %}{% if data.tanggal_pelaksanaan.all|length > 10 %}<span class="text-muted small">(...dan lainnya)</span>{% endif %}</div></td>
<td class="text-center"><div class="progress" style="min-width:60px" role="progressbar" aria-valuenow="{{ data.get_progress_percent }}" aria-valuemin="0" aria-valuemax="100"><div class="progress-bar bg-success" style="width:{{ data.get_progress_percent }}%">{{ data.get_progress_percent }}%</div></div></td>
<td class="p-1">
    <div class="d-grid" style="grid-template-columns: repeat(2, 1fr); gap: 4px; max-width: 100px;">
        {% for att in data.attachments.all|slice:":4" %}
        <a href="#" class="attachment-thumbnail" 
           data-job-id="{{ data.id }}"
           data-attachment-index="{{ forloop.counter0 }}"
           data-bs-toggle="modal" 
           data-bs-target="#attachmentModal"
           title="{{ att.deskripsi|default:att.file.name }}"
           onclick="loadAttachmentGallery({{ data.id }}, {{ forloop.counter0 }}); return false;">
            {% if att.tipe_file == 'Image' %}
                <img src="{{ att.file.url }}" class="thumbnail-pic" alt="{{ att.deskripsi }}" style="width: 45px; height: 45px;">
            {% else %}
                <i class="bi bi-file-earmark-text-fill" style="font-size: 2rem; color: #6c757d;"></i>
            {% endif %}
        </a>
        {% endfor %}
    </div>
    {% if data.attachments.all|length > 4 %}
    <div class="mt-1">
        <a href="#" class="text-decoration-none small text-primary" 
           data-bs-toggle="modal" 
           data-bs-target="#attachmentModal"
           onclick="loadAttachmentGallery({{ data.id }}, 0); return false;">
            +({{ data.attachments.all|length|add:"-4" }}) lagi
        </a>
    </div>
    {% endif %}
</td>
<td class="text-center">{% if data|can_edit_job:request.user %}<a href="{% url 'core:job_edit' data.id %}" class="btn btn-sm btn-outline-warning py-0 px-1" title="Edit Job"><i class="bi bi-pencil"></i></a> <a href="{% url 'core:job_delete' data.id %}" class="btn btn-sm btn-outline-danger py-0 px-1" title="Hapus Job" onclick="return confirm('Anda yakin ingin menghapus job: {{ data.nama_pekerjaan }}?')"><i class="bi bi-trash"></i></a>{% endif %}</td>
</tr>
{% empty %}
<tr><td colspan="13" class="text-center p-4">Tidak ada pekerjaan untuk ditampilkan.</td></tr>
{% endfor %}
        </tbody>
    </table>
</div>
